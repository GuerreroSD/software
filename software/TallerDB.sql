-- TABLA DE USUARIOS (RF-1 Control de acceso)
CREATE TABLE USUARIOS (
    ID_USUARIO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EMAIL VARCHAR2(100) UNIQUE NOT NULL,
    PASSWORD VARCHAR2(255) NOT NULL,
    NOMBRE_COMPLETO VARCHAR2(100),
    ROL VARCHAR2(50) DEFAULT 'ADMIN',
    ESTADO VARCHAR2(20) DEFAULT 'ACTIVA'
);

-- Insertar usuario admin (Password: 'admin123')
INSERT INTO USUARIOS (EMAIL, PASSWORD, NOMBRE_COMPLETO, ROL) 
VALUES ('admin@kovacs.cl', '$2y$10$wS1.0/8qJ1.1...', 'Administrador Kovacs', 'JEFE_TALLER');

-- TABLA VEHICULOS (RF-2, RF-3, RF-9)
CREATE TABLE VEHICULOS (
    ID_VEHICULO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    VIN VARCHAR2(17) NOT NULL,
    PATENTE VARCHAR2(10) NOT NULL,
    MARCA_MODELO VARCHAR2(100),
    NOMBRE_CLIENTE VARCHAR2(100),
    RUT_CLIENTE VARCHAR2(20),
    TIPO_CLIENTE VARCHAR2(20), -- 'PARTICULAR' o 'SEGURO'
    ESTADO_ACTUAL VARCHAR2(50) DEFAULT 'RECEPCIONADO',
    UBICACION VARCHAR2(20) DEFAULT 'EXTERIOR',
    FECHA_INGRESO DATE DEFAULT SYSDATE,
    FECHA_ULTIMO_CAMBIO TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT UK_VEHICULO_ACTIVO UNIQUE (PATENTE, VIN)
);

-- ASIGNACIONES (RF-11)
CREATE TABLE ASIGNACIONES (
    ID_ASIGNACION NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_VEHICULO NUMBER NOT NULL,
    ID_MECANICO NUMBER NOT NULL, -- RELACION CON USUARIOS
    FECHA_ASIGNACION DATE DEFAULT SYSDATE,
    FOREIGN KEY (ID_VEHICULO) REFERENCES VEHICULOS(ID_VEHICULO),
    FOREIGN KEY (ID_MECANICO) REFERENCES USUARIOS(ID_USUARIO)
);

-- DOCUMENTOS (RF-16)
CREATE TABLE DOCUMENTOS (
    ID_DOC NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_VEHICULO NUMBER NOT NULL,
    RUTA_ARCHIVO VARCHAR2(255),
    SUBIDO_POR NUMBER,
    FECHA_SUBIDA DATE DEFAULT SYSDATE,
    FOREIGN KEY (ID_VEHICULO) REFERENCES VEHICULOS(ID_VEHICULO)
);

-- HISTORIAL (RF-19)
CREATE TABLE HISTORIAL_VEHICULOS (
    ID_HIST NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_VEHICULO NUMBER,
    ESTADO_ANTERIOR VARCHAR2(50),
    ESTADO_NUEVO VARCHAR2(50),
    ID_USUARIO NUMBER,
    FECHA TIMESTAMP DEFAULT SYSTIMESTAMP
);


-- Tabla para detalles del presupuesto [cite: 127]
CREATE TABLE DETALLE_PRESUPUESTO (
    ID_DETALLE NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_VEHICULO NUMBER NOT NULL,
    DESCRIPCION VARCHAR2(200),
    TIPO VARCHAR2(20) CHECK (TIPO IN ('REPUESTO', 'MANO_OBRA')),
    COSTO NUMBER,
    CANTIDAD NUMBER DEFAULT 1,
    FOREIGN KEY (ID_VEHICULO) REFERENCES VEHICULOS(ID_VEHICULO)
);

-- Agregamos las columnas para el RF-3 si no están
ALTER TABLE VEHICULOS ADD COMPANIA_SEGUROS VARCHAR2(100);
ALTER TABLE VEHICULOS ADD NUMERO_SINIESTRO VARCHAR2(50);
ALTER TABLE VEHICULOS ADD ABONO_PAGADO CHAR(1) DEFAULT '0';
ALTER TABLE VEHICULOS ADD ESTADO_ACTUAL_OT VARCHAR(50) DEFAULT 'EN_ESPERA';
COMMIT;


-- TABLA PARA ÓRDENES DE TRABAJO (RF-6)
CREATE TABLE ORDENES_TRABAJO (
    ID_OT NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_VEHICULO NUMBER NOT NULL,
    FECHA_APROBACION DATE DEFAULT SYSDATE,
    ESTADO VARCHAR2(20) DEFAULT 'EN_PROCESO',
    TOTAL_APROBADO NUMBER,
    FOREIGN KEY (ID_VEHICULO) REFERENCES VEHICULOS(ID_VEHICULO)
);

-- TABLA PARA SOLICITUDES DE REPUESTOS (RF-7 y RF-8)
CREATE TABLE SOLICITUDES_REPUESTOS (
    ID_SOLICITUD NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_VEHICULO NUMBER NOT NULL,
    NUMERO_PARTE VARCHAR2(50) NOT NULL,
    DESCRIPCION VARCHAR2(200),
    CANTIDAD NUMBER NOT NULL,
    PROVEEDOR VARCHAR2(100),
    ESTADO VARCHAR2(20) DEFAULT 'SOLICITADO', -- SOLICITADO, EN_TRANSITO, RECIBIDO
    FECHA_SOLICITUD DATE DEFAULT SYSDATE,
    FOREIGN KEY (ID_VEHICULO) REFERENCES VEHICULOS(ID_VEHICULO)
);
COMMIT;
